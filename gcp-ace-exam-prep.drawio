<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:147.0) Gecko/20100101 Firefox/147.0" version="29.4.0">
  <diagram name="Page-1" id="fJa-bGf0KtOeBzwlbln7">
    <mxGraphModel dx="1055" dy="608" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="41zspn_ZCD3zTolKA1WF-1" parent="1" style="shape=table;startSize=0;container=1;collapsible=0;childLayout=tableLayout;" value="" vertex="1">
          <mxGeometry height="1340" width="960" x="40" y="30" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-2" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" value="" vertex="1">
          <mxGeometry height="40" width="960" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-3" parent="41zspn_ZCD3zTolKA1WF-2" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;rowspan=1;colspan=3;fontStyle=1" value="Implementing least privilege policy bindings in Cloud Run" vertex="1">
          <mxGeometry height="40" width="960" as="geometry">
            <mxRectangle height="40" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-4" parent="41zspn_ZCD3zTolKA1WF-2" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="" vertex="1" visible="0">
          <mxGeometry height="40" width="410" x="230" as="geometry">
            <mxRectangle height="40" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-26" parent="41zspn_ZCD3zTolKA1WF-2" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" vertex="1" visible="0">
          <mxGeometry height="40" width="320" x="640" as="geometry">
            <mxRectangle height="40" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-5" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="40" width="960" y="40" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-6" parent="41zspn_ZCD3zTolKA1WF-5" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Enable Cloud run service" vertex="1">
          <mxGeometry height="40" width="230" as="geometry">
            <mxRectangle height="40" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-7" parent="41zspn_ZCD3zTolKA1WF-5" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="gcloud services enable run.googleapis.com" vertex="1">
          <mxGeometry height="40" width="410" x="230" as="geometry">
            <mxRectangle height="40" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-27" parent="41zspn_ZCD3zTolKA1WF-5" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="40" width="320" x="640" as="geometry">
            <mxRectangle height="40" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-8" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="40" width="960" y="80" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-9" parent="41zspn_ZCD3zTolKA1WF-8" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Create a location environment variable" vertex="1">
          <mxGeometry height="40" width="230" as="geometry">
            <mxRectangle height="40" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-10" parent="41zspn_ZCD3zTolKA1WF-8" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="export LOCATION=us-central1" vertex="1">
          <mxGeometry height="40" width="410" x="230" as="geometry">
            <mxRectangle height="40" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-28" parent="41zspn_ZCD3zTolKA1WF-8" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="40" width="320" x="640" as="geometry">
            <mxRectangle height="40" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-11" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="40" width="960" y="120" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-12" parent="41zspn_ZCD3zTolKA1WF-11" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Set the default cloud run region" vertex="1">
          <mxGeometry height="40" width="230" as="geometry">
            <mxRectangle height="40" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-13" parent="41zspn_ZCD3zTolKA1WF-11" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="gcloud config set run/region $LOCATION" vertex="1">
          <mxGeometry height="40" width="410" x="230" as="geometry">
            <mxRectangle height="40" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-29" parent="41zspn_ZCD3zTolKA1WF-11" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="40" width="320" x="640" as="geometry">
            <mxRectangle height="40" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-14" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="70" width="960" y="160" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-15" parent="41zspn_ZCD3zTolKA1WF-14" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Deploy billing application image to Cloud Run&lt;br&gt;&lt;b&gt;any user on the internet should be able to access it&lt;/b&gt;" vertex="1">
          <mxGeometry height="70" width="230" as="geometry">
            <mxRectangle height="70" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-16" parent="41zspn_ZCD3zTolKA1WF-14" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="gcloud run deploy billing-service --image &amp;lt;image-path&amp;gt;" vertex="1">
          <mxGeometry height="70" width="410" x="230" as="geometry">
            <mxRectangle height="70" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-30" parent="41zspn_ZCD3zTolKA1WF-14" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="gcr.io/qwiklabs-resources/gsp723-parking-service" vertex="1">
          <mxGeometry height="70" width="320" x="640" as="geometry">
            <mxRectangle height="70" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-17" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="70" width="960" y="230" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-18" parent="41zspn_ZCD3zTolKA1WF-17" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Once deployed, set the value of the service URL on BILLING_SERVICE_URL environment variable" vertex="1">
          <mxGeometry height="70" width="230" as="geometry">
            <mxRectangle height="70" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-19" parent="41zspn_ZCD3zTolKA1WF-17" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="BILLING_SERVICE_URL=$(gcloud run services billing-service --filter &quot;value(URL)&quot;)" vertex="1">
          <mxGeometry height="70" width="410" x="230" as="geometry">
            <mxRectangle height="70" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-31" parent="41zspn_ZCD3zTolKA1WF-17" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="70" width="320" x="640" as="geometry">
            <mxRectangle height="70" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-32" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="300" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-33" parent="41zspn_ZCD3zTolKA1WF-32" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Run a POST curl on the URL" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-34" parent="41zspn_ZCD3zTolKA1WF-32" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="&lt;pre class=&quot;bash wrap hljs&quot;&gt;curl -X POST -H &lt;span class=&quot;hljs-string&quot;&gt;&quot;Content-Type: application/json&quot;&lt;/span&gt; \&lt;br&gt;&lt;span class=&quot;hljs-variable&quot;&gt;$BILLING_SERVICE_URL&lt;/span&gt; \&lt;br&gt;-d &lt;span class=&quot;hljs-string&quot;&gt;&#39;{&quot;userid&quot;: &quot;1234&quot;, &quot;minBalance&quot;: 100}&#39;&lt;/span&gt;&lt;/pre&gt;" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-35" parent="41zspn_ZCD3zTolKA1WF-32" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="&lt;pre class=&quot;bash wrap hljs&quot;&gt;&lt;span class=&quot;hljs-string&quot;&gt;&#39;{&quot;userid&quot;: &quot;1234&quot;, &quot;minBalance&quot;: 100}&#39;&lt;/span&gt;&lt;/pre&gt;" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-36" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="380" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-37" parent="41zspn_ZCD3zTolKA1WF-36" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Review the call made in the logs on GC Console and notice minBalance entry" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-38" parent="41zspn_ZCD3zTolKA1WF-36" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="NA" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-39" parent="41zspn_ZCD3zTolKA1WF-36" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-40" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="460" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-41" parent="41zspn_ZCD3zTolKA1WF-40" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="View the iam policy on the service&amp;nbsp;" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-42" parent="41zspn_ZCD3zTolKA1WF-40" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="gcloud run services billing-service get-iam-policy" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-43" parent="41zspn_ZCD3zTolKA1WF-40" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-44" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="540" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-45" parent="41zspn_ZCD3zTolKA1WF-44" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Remove policy binding from the service" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-46" parent="41zspn_ZCD3zTolKA1WF-44" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="gcloud run services billing-service remove-iam-policy-binding --members allUsers --role roles/run.invoker" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-47" parent="41zspn_ZCD3zTolKA1WF-44" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="Now, the call fails.&amp;nbsp; So, we&#39;ll create a service account with roles/run.invoker and assign use it in our cloud shell and then try to call the service again" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-48" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="620" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-49" parent="41zspn_ZCD3zTolKA1WF-48" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Create a service account" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-50" parent="41zspn_ZCD3zTolKA1WF-48" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="gcloud iam services-accounts create billing-initiator --display-name &quot;Billing Initiator&quot;" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-51" parent="41zspn_ZCD3zTolKA1WF-48" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-52" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="700" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-53" parent="41zspn_ZCD3zTolKA1WF-52" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Grant roles/run.invoker permission on console" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-54" parent="41zspn_ZCD3zTolKA1WF-52" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-55" parent="41zspn_ZCD3zTolKA1WF-52" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-56" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="780" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-57" parent="41zspn_ZCD3zTolKA1WF-56" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Set the billing-initiator SA email on env variable&amp;nbsp;" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-58" parent="41zspn_ZCD3zTolKA1WF-56" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="BILLING_INITIATOR_EMAIL=$(gcloud iam service-accounts list --filter billing-initiator --format &quot;value(EMAIL)&quot;)&amp;nbsp; &amp;amp;&amp;amp; echo&amp;nbsp;$BILLING_INITIATOR_EMAIL" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-59" parent="41zspn_ZCD3zTolKA1WF-56" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-60" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="860" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-61" parent="41zspn_ZCD3zTolKA1WF-60" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Create a key file for the service account" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-62" parent="41zspn_ZCD3zTolKA1WF-60" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="&lt;pre class=&quot;bash wrap hljs&quot;&gt;gcloud iam service-accounts keys create key.json \&lt;br&gt;--iam-account=&lt;span class=&quot;hljs-variable&quot;&gt;${BILLING_INITIATOR_EMAIL}&lt;/span&gt;&lt;/pre&gt;" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-63" parent="41zspn_ZCD3zTolKA1WF-60" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=inherit;overflow=hidden;fillColor=none;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-64" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="940" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-65" parent="41zspn_ZCD3zTolKA1WF-64" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=#6c8ebf;overflow=hidden;fillColor=#dae8fc;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="&lt;b&gt;In a new Cloud Shell Tab&lt;/b&gt;&lt;br&gt;Activate the service account in the shell" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-66" parent="41zspn_ZCD3zTolKA1WF-64" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=#6c8ebf;overflow=hidden;fillColor=#dae8fc;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="&lt;pre class=&quot;bash wrap hljs&quot;&gt;gcloud auth activate-service-account \&lt;br&gt;--key-file=key.json&lt;/pre&gt;" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-67" parent="41zspn_ZCD3zTolKA1WF-64" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=#6c8ebf;overflow=hidden;fillColor=#dae8fc;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="After a minute or two, again try to call the service and it should be successful" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-72" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="1020" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-73" parent="41zspn_ZCD3zTolKA1WF-72" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=#6c8ebf;overflow=hidden;fillColor=#dae8fc;top=0;left=0;bottom=0;right=0;pointerEvents=1;" value="Invoke the service" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-74" parent="41zspn_ZCD3zTolKA1WF-72" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=#6c8ebf;overflow=hidden;fillColor=#dae8fc;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;" value="&amp;nbsp;curl -X POST -H &quot;Content-Type: application/json&quot; \&lt;br&gt;&amp;nbsp; -H &quot;Authorization: Bearer $(gcloud auth print-identity-token)&quot; \&lt;br&gt;&amp;nbsp; $BILLING_SERVICE_URL -d &#39;{&quot;userid&quot;: &quot;1234&quot;, &quot;minBalance&quot;: 500}&#39;" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-75" parent="41zspn_ZCD3zTolKA1WF-72" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;strokeColor=#6c8ebf;overflow=hidden;fillColor=#dae8fc;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;" value="This works because the service account is activated on this shell" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-76" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="1100" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-77" parent="41zspn_ZCD3zTolKA1WF-76" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fillColor=none;" value="Deploy a second service (using the same image)" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-78" parent="41zspn_ZCD3zTolKA1WF-76" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;fillColor=none;" value="gcloud run deploy billing-service-2 --image nginxinc/nginx-unprivileged --platform managed --no-allow-unathenticated" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-79" parent="41zspn_ZCD3zTolKA1WF-76" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;fillColor=none;" value="nginxinc/nginx-unprivileged" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-80" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="1180" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-81" parent="41zspn_ZCD3zTolKA1WF-80" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" value="Try accessing the service in the 2nd terminal" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-82" parent="41zspn_ZCD3zTolKA1WF-80" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" value="BILLING_SERVICE_2_URL=$(gcloud run services list --filter billing-service-2 --format &quot;value(URL)&quot;)" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-83" parent="41zspn_ZCD3zTolKA1WF-80" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;" value="We are still able to access so our service account doesn&#39;t have least-privileged principle in use.&amp;nbsp; It should have&amp;nbsp;" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-84" parent="41zspn_ZCD3zTolKA1WF-1" style="shape=tableRow;horizontal=0;startSize=0;swimlaneHead=0;swimlaneBody=0;strokeColor=inherit;top=0;left=0;bottom=0;right=0;collapsible=0;dropTarget=0;fillColor=none;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1">
          <mxGeometry height="80" width="960" y="1260" as="geometry" />
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-85" parent="41zspn_ZCD3zTolKA1WF-84" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fillColor=none;strokeColor=#6c8ebf;" vertex="1">
          <mxGeometry height="80" width="230" as="geometry">
            <mxRectangle height="80" width="230" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-86" parent="41zspn_ZCD3zTolKA1WF-84" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;align=center;fillColor=none;strokeColor=#6c8ebf;" vertex="1">
          <mxGeometry height="80" width="410" x="230" as="geometry">
            <mxRectangle height="80" width="410" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="41zspn_ZCD3zTolKA1WF-87" parent="41zspn_ZCD3zTolKA1WF-84" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;overflow=hidden;top=0;left=0;bottom=0;right=0;pointerEvents=1;fontFamily=Courier New;fillColor=none;strokeColor=#6c8ebf;" vertex="1">
          <mxGeometry height="80" width="320" x="640" as="geometry">
            <mxRectangle height="80" width="320" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
